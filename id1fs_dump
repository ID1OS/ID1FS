import click
import json
import getpass
import hashlib
import sys
import random

def hash_string(input_string):
    """Hash a string using SHA-256."""
    sha256_hash = hashlib.sha256()
    sha256_hash.update(input_string.encode('utf-8'))
    return sha256_hash.hexdigest()

@click.command()
@click.option("-u", "--username", prompt="the username ", help="Enter the username")
def signup(username):
    """Create a user in ID1FS"""
    try:
        with open("login.json", "r") as f:
            users = json.load(f)
    except FileNotFoundError:
        users = {}
    except json.decoder.JSONDecodeError:
        users = {}
    if username in users.keys():
        click.echo(f"This username is already in use.\nTry {username}{random.randint(100, 999)}, {username}{random.randint(100, 999)}{random.randint(100, 999)} or {username}{random.randint(100, 999)}{random.randint(100, 999)}{random.randint(100, 999)}")
        sys.exit()
    while True:
        password = getpass.getpass("Enter the password : ")
        repassword = getpass.getpass("Renter the password : ")
        if password == repassword:
            with open("login.json", "w") as f:
                users[username] = hash_string(password)
                json.dump(users, f)
            break
        else:
            click.echo("The passwords don't match.")
            continue

@click.command()
@click.argument("user", type=str, required=1)
def deltusr(user):
    """Delete a user from ID1FS."""
    try:
        with open("login.json", "r")as f:
            users = json.load(f)
    except FileNotFoundError:
        click.echo("No users found.")
        sys.exit()
    except json.decoder.JSONDecodeError:
        click.echo("No users found.")
        sys.exit()
    if user not in users.keys():
        click.echo("This user doesn't exist.")
        sys.exit()
    password=getpass.getpass("Enter the user password :")
    password=hash_string(password)
    if password == users[user].strip():
        print("User deleted.")
        del users[user]
        with open("login.json", "w")as f:
            json.dump(users, f)
    else:
        click.echo("Wrong password.")
        sys.exit()
